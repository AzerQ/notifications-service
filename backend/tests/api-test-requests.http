### NotificationService API - Примеры запросов с аутентификацией

@baseUrl = http://localhost:5000
@email = test@examle.com

### === АУТЕНТИФИКАЦИЯ ===

### === 1. Email Authentication ===

### 1.1. Отправить код на email (Test user 1 - Role: User)
POST {{baseUrl}}/api/auth/email/sendCode?email={{email}}

> {%
  client.global.set("challengeId", response.body.id);
  client.log("Challenge ID: " + response.body.id);
%}

### 1.2. Войти с кодом (замените код на полученный в email/консоли)
POST {{baseUrl}}/api/auth/email
Content-Type: application/json

{
  "id": "{{challengeId}}",
  "code": "123456"
}

> {%
  client.global.set("accessToken", response.body.accessToken);
  client.global.set("refreshToken", response.body.refreshToken);
  client.log("Access Token: " + response.body.accessToken);
  client.log("Refresh Token: " + response.body.refreshToken);
  
  // Декодировать JWT для проверки claims
  try {
    const parts = response.body.accessToken.split('.');
    if (parts.length >= 2) {
      const payload = Buffer.from(parts[1], 'base64').toString();
      const claims = JSON.parse(payload);
      client.log("JWT Claims:");
      client.log("  - sub (User ID): " + claims.sub);
      client.log("  - name: " + claims.name);
      client.log("  - email: " + claims.email);
   client.log("  - role: " + claims.role);
   client.log("  - exp: " + new Date(claims.exp * 1000));
      
      // Сохранить user ID для последующих запросов
      if (claims.sub) {
        client.global.set("currentUserId", claims.sub);
      }
    }
  } catch (e) {
    client.log("Could not decode JWT: " + e);
  }
%}

### 1.3. Login as Admin (для тестирования Admin прав)
POST {{baseUrl}}/api/auth/email/sendCode?email=admin@examle.com

###
POST {{baseUrl}}/api/auth/email
Content-Type: application/json

{
  "id": "{{challengeId}}",
  "code": "123456"
}

> {%
  client.global.set("adminAccessToken", response.body.accessToken);
  client.global.set("adminRefreshToken", response.body.refreshToken);
  client.log("Admin Access Token received");
  
  // Декодировать для проверки
  try {
    const parts = response.body.accessToken.split('.');
    if (parts.length >= 2) {
      const payload = Buffer.from(parts[1], 'base64').toString();
      const claims = JSON.parse(payload);
      client.log("Admin Claims - Role: " + claims.role);
    }
  } catch (e) {}
%}

### === 2. Windows Authentication (сквозная авторизация) ===

### 2.1. Войти через Windows (требует настройки IIS или доменной сети)
# @name windowsAuth
POST {{baseUrl}}/api/auth/windows
Content-Type: application/json

# Примечание: Для работы Windows Authentication:
# 1. Запустите приложение с поддержкой Windows Auth (через IIS или Kestrel с настройками)
# 2. Убедитесь, что в системе есть пользователь с AccountName = ваше_доменное_имя
# 3. В REST Client может не работать - используйте PowerShell или Postman

> {%
  client.global.set("accessToken", response.body.accessToken);
  client.global.set("refreshToken", response.body.refreshToken);
  client.log("Windows Auth - Access Token: " + response.body.accessToken);
%}

### === 3. Обновление токена ===

### 3.1. Обновить access token
POST {{baseUrl}}/api/auth/refresh
Content-Type: application/json

{
  "refreshTokenValue": "{{refreshToken}}"
}

> {%
  client.global.set("accessToken", response.body.accessToken);
  client.log("New Access Token: " + response.body.accessToken);
%}

### === ТЕСТИРОВАНИЕ JWT CLAIMS ===

### Decode current JWT (визуальная проверка на jwt.io)
# Copy the token below and paste it to https://jwt.io/
# {{accessToken}}

### === ПОЛЬЗОВАТЕЛИ ===

### Получить всех пользователей (только Admin) - должен вернуть 403 для обычного пользователя
GET {{baseUrl}}/api/users
Authorization: Bearer {{accessToken}}

### Получить всех пользователей как Admin
GET {{baseUrl}}/api/users
Authorization: Bearer {{adminAccessToken}}

### Получить своего пользователя (доступно всем)
GET {{baseUrl}}/api/users/{{currentUserId}}
Authorization: Bearer {{accessToken}}

### Попытка получить чужого пользователя (должно вернуть 403)
GET {{baseUrl}}/api/users/b606cd21-7260-45b3-9e6f-6053690add9a
Authorization: Bearer {{accessToken}}

### === УВЕДОМЛЕНИЯ ===

### Создать уведомление
POST {{baseUrl}}/api/notification/UserRegistered
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "route": "UserRegistered",
  "channel": "Email",
"parameters": {
    "UserId": "{{currentUserId}}"
  }
}

### Получить свои уведомления
GET {{baseUrl}}/api/notification/by-user/{{currentUserId}}
Authorization: Bearer {{accessToken}}

### Попытка получить чужие уведомления (должно вернуть 403)
GET {{baseUrl}}/api/notification/by-user/b606cd21-7260-45b3-9e6f-6053690add9a
Authorization: Bearer {{accessToken}}

### Получить уведомления по статусу
GET {{baseUrl}}/api/notification/by-status/Sent
Authorization: Bearer {{accessToken}}

### Тестовая отправка (анонимный доступ)
POST {{baseUrl}}/api/notification/broadcast
Content-Type: application/json

{
  "title": "Test Notification",
  "message": "This is a test message",
  "route": "TestRoute"
}

### === НАСТРОЙКИ МАРШРУТОВ ===

### Получить свои настройки маршрутов
GET {{baseUrl}}/api/users/{{currentUserId}}/routes
Authorization: Bearer {{accessToken}}

### Обновить свои настройки маршрутов
PUT {{baseUrl}}/api/users/{{currentUserId}}/routes
Authorization: Bearer {{accessToken}}
Content-Type: application/json

[
  {
"route": "UserRegistered",
    "enabled": true
  },
  {
    "route": "TaskAssigned",
    "enabled": false
  }
]

### Попытка изменить чужие настройки (должно вернуть 403)
PUT {{baseUrl}}/api/users/b606cd21-7260-45b3-9e6f-6053690add9a/routes
Authorization: Bearer {{accessToken}}
Content-Type: application/json

[
  {
    "route": "UserRegistered",
  "enabled": false
  }
]

### === ТЕСТИРОВАНИЕ РОЛЕЙ ===

### Admin: Получить всех пользователей (должно работать)
GET {{baseUrl}}/api/users
Authorization: Bearer {{adminAccessToken}}

### User: Получить всех пользователей (должно вернуть 403)
GET {{baseUrl}}/api/users
Authorization: Bearer {{accessToken}}

### === ТЕСТИРОВАНИЕ WINDOWS AUTH С POWERSHELL ===
# Сохраните этот скрипт в файл test-windows-auth.ps1 и запустите из PowerShell

<# 
# test-windows-auth.ps1
$baseUrl = "http://localhost:5000"

# Вход через Windows Authentication
$response = Invoke-RestMethod `
    -Uri "$baseUrl/api/auth/windows" `
    -Method POST `
    -UseDefaultCredentials `
    -ContentType "application/json"

Write-Host "Access Token: $($response.accessToken)"
Write-Host "Refresh Token: $($response.refreshToken)"

# Сохранить токен для последующих запросов
$accessToken = $response.accessToken

# Получить информацию о текущем пользователе
$headers = @{
    "Authorization" = "Bearer $accessToken"
}

$users = Invoke-RestMethod `
    -Uri "$baseUrl/api/users" `
    -Method GET `
    -Headers $headers

Write-Host "Users count: $($users.Count)"
#>